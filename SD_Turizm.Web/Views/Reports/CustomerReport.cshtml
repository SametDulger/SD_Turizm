@using System.Text.Json
@using System.Linq
@{
    ViewData["Title"] = "Müşteri Raporu";
}

<style>
    @@media print {
        .no-print { display: none !important; }
        .report-header { border-bottom: 3px solid #17a2b8; padding-bottom: 20px; margin-bottom: 30px; }
        .report-section { page-break-inside: avoid; margin-bottom: 30px; }
    }
    
    .report-header {
        text-align: center;
        border-bottom: 3px solid #17a2b8;
        padding-bottom: 20px;
        margin-bottom: 30px;
    }
    
    .company-info {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
    }
    
    .report-section {
        margin-bottom: 40px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        border-left: 5px solid #17a2b8;
    }
    
    .customer-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .customer-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-left: 5px solid;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    
    .customer-card::before {
        content: '';
        position: absolute;
        top: -20px;
        right: -20px;
        width: 80px;
        height: 80px;
        opacity: 0.1;
        background-size: 50px;
        background-repeat: no-repeat;
        background-position: center;
    }
    
    .card-total { border-left-color: #17a2b8; }
    .card-total::before { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="%2317a2b8" viewBox="0 0 24 24"><path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H16.8c-.8 0-1.54.5-1.85 1.26l-1.48 3.7L12 11.5l2.17 2.17h2.5v-2l1.33 4v6h2zm-6.5-10.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5S12 9.17 12 10.67s.67 1.5 1.5 1.5zM5.5 6c1.11 0 2-.89 2-2s-.89-2-2-2-2 .89-2 2 .89 2 2 2zm2 16v-6H9l-1.1-3.3A1.5 1.5 0 0 0 6.46 12H4.54c-.8 0-1.54.5-1.85 1.26L1.3 16H3v6h2.5z"/></svg>'); }
    
    .card-active { border-left-color: #28a745; }
    .card-active::before { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="%2328a745" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>'); }
    
    .card-revenue { border-left-color: #ffc107; }
    .card-revenue::before { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="%23ffc107" viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>'); }
    
    .card-average { border-left-color: #6f42c1; }
    .card-average::before { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="%236f42c1" viewBox="0 0 24 24"><path d="M7.5 4A5.5 5.5 0 0 0 2 9.5c0 .5-.4.9-.9.9s-.9-.4-.9-.9C.2 7.6 2.8 5 6 5c.5 0 .9.4.9.9s-.4.9-.9.9h1.5zM16.5 20A5.5 5.5 0 0 0 22 14.5c0-.5.4-.9.9-.9s.9.4.9.9c0 1.9-2.6 4.5-5.8 4.5-.5 0-.9-.4-.9-.9s.4-.9.9-.9h-1.5zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>'); }
    
    .customer-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 10px;
        position: relative;
        z-index: 1;
    }
    
    .customer-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
        position: relative;
        z-index: 1;
    }
    
    .customer-description {
        font-size: 0.8rem;
        margin-top: 5px;
        position: relative;
        z-index: 1;
        color: #6c757d;
    }
    
    .customer-list {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .customer-item {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        gap: 20px;
        align-items: center;
    }
    
    .customer-item:last-child { border-bottom: none; }
    .customer-item:nth-child(even) { background: #f8f9fa; }
    
    .customer-info {
        display: flex;
        align-items: center;
    }
    
    .customer-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #17a2b8, #138496);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
        margin-right: 15px;
    }
    
    .customer-name {
        font-weight: 600;
        color: #333;
    }
    
    .customer-email {
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    .customer-stats {
        text-align: center;
    }
    
    .stat-value {
        font-weight: bold;
        font-size: 1.1rem;
        color: #333;
    }
    
    .stat-label {
        font-size: 0.8rem;
        color: #6c757d;
        text-transform: uppercase;
    }
    
    .loyalty-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .loyalty-gold { background: #ffd700; color: #b8860b; }
    .loyalty-silver { background: #c0c0c0; color: #696969; }
    .loyalty-bronze { background: #cd7f32; color: #8b4513; }
    .loyalty-standard { background: #e9ecef; color: #6c757d; }
    
    .report-footer {
        margin-top: 50px;
        padding-top: 30px;
        border-top: 2px solid #17a2b8;
        text-align: center;
        color: #6c757d;
    }
</style>

<div class="container-fluid">
    <!-- Header Buttons -->
    <div class="d-flex justify-content-between align-items-center mb-4 mt-4 no-print">
        <div class="d-flex align-items-center">
            <div class="bg-gradient-info rounded-circle p-3 me-3 shadow-sm">
                <i class="fas fa-users fa-2x text-white"></i>
            </div>
            <div>
                <h1 class="h2 mb-0 text-dark fw-bold">Müşteri Raporu</h1>
                <p class="text-muted mb-0">Müşteri analizi ve segmentasyon raporu</p>
            </div>
        </div>
        <div>
            <button type="button" class="btn btn-info btn-lg me-2 shadow-sm" onclick="window.print()">
                <i class="fas fa-print me-2"></i>Yazdır
            </button>
            <button type="button" class="btn btn-primary btn-lg me-2 shadow-sm" data-bs-toggle="modal" data-bs-target="#filterModal">
                <i class="fas fa-filter me-2"></i>Filtrele
            </button>
            <a asp-action="Index" class="btn btn-secondary btn-lg shadow-sm">
                <i class="fas fa-arrow-left me-2"></i>Geri Dön
            </a>
        </div>
    </div>

    <!-- Report Header -->
    <div class="report-header">
        <div class="company-info">
            <h1 class="mb-3">
                <i class="fas fa-users me-3"></i>SD TURİZM
            </h1>
            <h2 class="h3 mb-0">MÜŞTERİ ANALİZ RAPORU</h2>
            @if (ViewBag.StartDate != null && ViewBag.EndDate != null)
            {
                <p class="mb-0 mt-2">
                    <i class="fas fa-calendar-alt me-2"></i>
                    @ViewBag.StartDate.ToString("dd MMMM yyyy") - @ViewBag.EndDate.ToString("dd MMMM yyyy")
                </p>
            }
            else
            {
                <p class="mb-0 mt-2">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Rapor Tarihi: @DateTime.Now.ToString("dd MMMM yyyy")
                </p>
            }
        </div>
    </div>

    <!-- Customer Overview -->
    @if (ViewBag.Summary != null)
    {
        <div class="report-section">
            <h3 class="mb-4">
                <i class="fas fa-chart-bar me-2"></i>
                Müşteri İstatistikleri
            </h3>
            
            <div class="customer-grid">
                <div class="customer-card card-total">
                    <div class="customer-value text-info">@ViewBag.Summary.TotalCustomers</div>
                    <div class="customer-label">Toplam Müşteri</div>
                    <div class="customer-description">Kayıtlı tüm müşteriler</div>
                </div>
                
                <div class="customer-card card-active">
                    <div class="customer-value text-success">@ViewBag.Summary.ActiveCustomers</div>
                    <div class="customer-label">Aktif Müşteri</div>
                    <div class="customer-description">Son 6 ay içinde alışveriş yapan</div>
                </div>
                
                <div class="customer-card card-revenue">
                    <div class="customer-value text-warning">₺@ViewBag.Summary.TotalCustomerValue.ToString("N0")</div>
                    <div class="customer-label">Toplam Müşteri Değeri</div>
                    <div class="customer-description">Tüm müşteri satışları toplamı</div>
                </div>
                
                <div class="customer-card card-average">
                    <div class="customer-value text-purple">₺@ViewBag.Summary.AverageCustomerValue.ToString("N0")</div>
                    <div class="customer-label">Ortalama Müşteri Değeri</div>
                    <div class="customer-description">Müşteri başına ortalama satış</div>
                </div>
            </div>
        </div>
    }

    <!-- Customer Segmentation -->
    <div class="report-section">
        <h3 class="mb-4">
            <i class="fas fa-layer-group me-2"></i>
            Müşteri Segmentasyonu
        </h3>
        
        <div class="row">
            <div class="col-md-3">
                <div class="customer-card card-total">
                    <div class="customer-value text-warning">
                        @(((IEnumerable<dynamic>)ViewBag.Customers ?? Enumerable.Empty<dynamic>()).Where(c => c.TotalPurchases >= 50000).Count())
                    </div>
                    <div class="customer-label">Premium Müşteri</div>
                    <div class="customer-description">₺50,000+ alışveriş</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="customer-card card-active">
                    <div class="customer-value text-success">
                        @(((IEnumerable<dynamic>)ViewBag.Customers ?? Enumerable.Empty<dynamic>()).Where(c => c.TotalPurchases >= 20000 && c.TotalPurchases < 50000).Count())
                    </div>
                    <div class="customer-label">VIP Müşteri</div>
                    <div class="customer-description">₺20,000-₺50,000 alışveriş</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="customer-card card-revenue">
                    <div class="customer-value text-info">
                        @(((IEnumerable<dynamic>)ViewBag.Customers ?? Enumerable.Empty<dynamic>()).Where(c => c.TotalPurchases >= 5000 && c.TotalPurchases < 20000).Count())
                    </div>
                    <div class="customer-label">Sadık Müşteri</div>
                    <div class="customer-description">₺5,000-₺20,000 alışveriş</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="customer-card card-average">
                    <div class="customer-value text-secondary">
                        @(((IEnumerable<dynamic>)ViewBag.Customers ?? Enumerable.Empty<dynamic>()).Where(c => c.TotalPurchases < 5000).Count())
                    </div>
                    <div class="customer-label">Standart Müşteri</div>
                    <div class="customer-description">₺5,000 altı alışveriş</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Customers -->
    @if (ViewBag.Customers != null)
    {
        <div class="report-section">
            <h3 class="mb-4">
                <i class="fas fa-crown me-2"></i>
                En Değerli Müşteriler
            </h3>
            
            <div class="customer-list">
                <div class="customer-item" style="background: #17a2b8; color: white; font-weight: bold;">
                    <div>Müşteri Bilgileri</div>
                    <div class="text-center">Toplam Alışveriş</div>
                    <div class="text-center">Sipariş Sayısı</div>
                    <div class="text-center">Müşteri Kategorisi</div>
                </div>
                
                @{
                    var topCustomers = ((IEnumerable<dynamic>)ViewBag.Customers ?? Enumerable.Empty<dynamic>()).OrderByDescending(c => c.TotalPurchases).Take(10);
                }
                
                @foreach (var customer in topCustomers)
                {
                    var loyaltyClass = "loyalty-standard";
                    var loyaltyText = "Standart";
                    
                    if (customer.TotalPurchases >= 50000)
                    {
                        loyaltyClass = "loyalty-gold";
                        loyaltyText = "Premium";
                    }
                    else if (customer.TotalPurchases >= 20000)
                    {
                        loyaltyClass = "loyalty-silver";
                        loyaltyText = "VIP";
                    }
                    else if (customer.TotalPurchases >= 5000)
                    {
                        loyaltyClass = "loyalty-bronze";
                        loyaltyText = "Sadık";
                    }
                    
                    <div class="customer-item">
                        <div class="customer-info">
                            <div class="customer-avatar">
                                @customer.CustomerName.Substring(0, Math.Min(2, customer.CustomerName.Length)).ToUpper()
                            </div>
                            <div>
                                <div class="customer-name">@customer.CustomerName</div>
                                <div class="customer-email">
                                    <i class="fas fa-calendar me-1"></i>
                                    Son Alışveriş: @customer.LastPurchaseDate.ToString("dd.MM.yyyy")
                                </div>
                            </div>
                        </div>
                        
                        <div class="customer-stats">
                            <div class="stat-value text-success">₺@customer.TotalPurchases.ToString("N0")</div>
                            <div class="stat-label">Toplam Harcama</div>
                        </div>
                        
                        <div class="customer-stats">
                            <div class="stat-value text-primary">@customer.TotalOrders</div>
                            <div class="stat-label">Sipariş Adedi</div>
                        </div>
                        
                        <div class="text-center">
                            <span class="loyalty-badge @loyaltyClass">
                                <i class="fas fa-medal me-1"></i>@loyaltyText
                            </span>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Customer Analytics -->
    <div class="report-section">
        <h3 class="mb-4">
            <i class="fas fa-analytics me-2"></i>
            Müşteri Davranış Analizi
        </h3>
        
        <div class="row">
            <div class="col-md-6">
                <div class="customer-card">
                    <h5 class="mb-3">Müşteri Dağılımı</h5>
                    <div class="row">
                        <div class="col-6 text-center">
                            <div class="customer-value text-warning" style="font-size: 1.8rem;">
                                %@(ViewBag.Summary?.TotalCustomers > 0 ? ((ViewBag.Summary.ActiveCustomers * 100.0) / ViewBag.Summary.TotalCustomers).ToString("N0") : "0")
                            </div>
                            <div class="customer-label">Aktif Oran</div>
                        </div>
                        <div class="col-6 text-center">
                            <div class="customer-value text-info" style="font-size: 1.8rem;">
                                @(ViewBag.Summary?.TotalCustomers > 0 ? (ViewBag.Summary.TotalCustomers - ViewBag.Summary.ActiveCustomers) : 0)
                            </div>
                            <div class="customer-label">Pasif Müşteri</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="customer-card">
                    <h5 class="mb-3">Satış Performansı</h5>
                    <div class="row">
                        <div class="col-6 text-center">
                            <div class="customer-value text-success" style="font-size: 1.8rem;">
                                ₺@(ViewBag.Summary?.ActiveCustomers > 0 ? (ViewBag.Summary.TotalCustomerValue / ViewBag.Summary.ActiveCustomers).ToString("N0") : "0")
                            </div>
                            <div class="customer-label">Aktif Ort. Değer</div>
                        </div>
                        <div class="col-6 text-center">
                            <div class="customer-value text-primary" style="font-size: 1.8rem;">
                                @(ViewBag.Summary?.ActiveCustomers > 0 ? ((((IEnumerable<dynamic>)ViewBag.Customers ?? Enumerable.Empty<dynamic>()).Sum(c => (decimal)(c.TotalOrders ?? 0))) / ViewBag.Summary.ActiveCustomers).ToString("N1") : "0")
                            </div>
                            <div class="customer-label">Ort. Sipariş</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Footer -->
    <div class="report-footer">
        <p>
            <i class="fas fa-calendar me-2"></i>
            Rapor Oluşturma Tarihi: @DateTime.Now.ToString("dd MMMM yyyy HH:mm")
        </p>
        <p class="mb-0">
            <i class="fas fa-building me-2"></i>
            SD Turizm - Müşteri Analiz Sistemi
        </p>
    </div>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-filter me-2"></i>Müşteri Rapor Filtreleri
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="get">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-calendar me-1"></i>Başlangıç Tarihi
                                </label>
                                <input type="date" class="form-control" name="startDate" value="@ViewBag.StartDate?.ToString("yyyy-MM-dd")" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-calendar me-1"></i>Bitiş Tarihi
                                </label>
                                <input type="date" class="form-control" name="endDate" value="@ViewBag.EndDate?.ToString("yyyy-MM-dd")" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-medal me-1"></i>Müşteri Kategorisi
                                </label>
                                <select class="form-select" name="customerType">
                                    <option value="">Tümü</option>
                                    <option value="premium">Premium (₺50,000+)</option>
                                    <option value="vip">VIP (₺20,000-₺50,000)</option>
                                    <option value="loyal">Sadık (₺5,000-₺20,000)</option>
                                    <option value="standard">Standart (₺5,000 altı)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-toggle-on me-1"></i>Durum
                                </label>
                                <select class="form-select" name="status">
                                    <option value="">Tümü</option>
                                    <option value="active">Aktif</option>
                                    <option value="inactive">Pasif</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>İptal
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-1"></i>Filtrele
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>