@using System.Text.Json
@{
    ViewData["Title"] = "Finansal Rapor";
}

<style>
    @@media print {
        .no-print { display: none !important; }
        .report-header { border-bottom: 3px solid #28a745; padding-bottom: 20px; margin-bottom: 30px; }
        .report-section { page-break-inside: avoid; margin-bottom: 30px; }
    }
    
    .report-header {
        text-align: center;
        border-bottom: 3px solid #28a745;
        padding-bottom: 20px;
        margin-bottom: 30px;
    }
    
    .company-info {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
    }
    
    .report-section {
        margin-bottom: 40px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        border-left: 5px solid #28a745;
    }
    
    .financial-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .financial-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-left: 5px solid;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    
    .financial-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        opacity: 0.1;
        background-size: 60px;
        background-repeat: no-repeat;
        background-position: center;
    }
    
    .card-revenue { border-left-color: #28a745; }
    .card-revenue::before { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="%2328a745" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>'); }
    
    .card-cost { border-left-color: #ffc107; }
    .card-cost::before { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="%23ffc107" viewBox="0 0 24 24"><path d="M7 18c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>'); }
    
    .card-profit { border-left-color: #dc3545; }
    .card-profit::before { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="%23dc3545" viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6h-6z"/></svg>'); }
    
    .card-margin { border-left-color: #17a2b8; }
    .card-margin::before { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="%2317a2b8" viewBox="0 0 24 24"><path d="M9 11H7v6h2v-6zm4 0h-2v6h2v-6zm4 0h-2v6h2v-6zm2.5-5H18V4l-1-1H7L6 4v2H4.5C3.67 6 3 6.67 3 7.5S3.67 9 4.5 9H6v8c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V9h1.5c.83 0 1.5-.67 1.5-1.5S19.83 6 19.5 6z"/></svg>'); }
    
    .financial-value {
        font-size: 2.8rem;
        font-weight: bold;
        margin-bottom: 10px;
        position: relative;
        z-index: 1;
    }
    
    .financial-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
        position: relative;
        z-index: 1;
    }
    
    .financial-change {
        font-size: 0.8rem;
        margin-top: 5px;
        position: relative;
        z-index: 1;
    }
    
    .profit-breakdown {
        background: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .breakdown-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #eee;
        font-size: 1.1rem;
    }
    
    .breakdown-item:last-child { border-bottom: none; font-weight: bold; font-size: 1.2rem; }
    
    .breakdown-label {
        display: flex;
        align-items: center;
    }
    
    .breakdown-value {
        font-weight: 600;
    }
    
    .monthly-summary {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .month-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #f1f1f1;
    }
    
    .month-item:last-child { border-bottom: none; }
    
    .month-name {
        font-weight: 600;
        color: #495057;
    }
    
    .month-values {
        display: flex;
        gap: 30px;
        font-weight: 600;
    }
    
    .report-footer {
        margin-top: 50px;
        padding-top: 30px;
        border-top: 2px solid #28a745;
        text-align: center;
        color: #6c757d;
    }
</style>

<div class="container-fluid">
    <!-- Header Buttons -->
    <div class="d-flex justify-content-between align-items-center mb-4 mt-4 no-print">
        <div class="d-flex align-items-center">
            <div class="bg-gradient-success rounded-circle p-3 me-3 shadow-sm">
                <i class="fas fa-chart-pie fa-2x text-white"></i>
            </div>
            <div>
                <h1 class="h2 mb-0 text-dark fw-bold">Finansal Rapor</h1>
                <p class="text-muted mb-0">Detaylı finansal analiz ve kârlılık raporu</p>
            </div>
        </div>
        <div>
            <button type="button" class="btn btn-success btn-lg me-2 shadow-sm" onclick="window.print()">
                <i class="fas fa-print me-2"></i>Yazdır
            </button>
            <button type="button" class="btn btn-primary btn-lg me-2 shadow-sm" data-bs-toggle="modal" data-bs-target="#filterModal">
                <i class="fas fa-filter me-2"></i>Filtrele
            </button>
            <a asp-action="Index" class="btn btn-secondary btn-lg shadow-sm">
                <i class="fas fa-arrow-left me-2"></i>Geri Dön
            </a>
        </div>
    </div>

    <!-- Report Header -->
    <div class="report-header">
        <div class="company-info">
            <h1 class="mb-3">
                <i class="fas fa-chart-line me-3"></i>SD TURİZM
            </h1>
            <h2 class="h3 mb-0">FİNANSAL RAPORU</h2>
            @if (ViewBag.StartDate != null && ViewBag.EndDate != null)
            {
                <p class="mb-0 mt-2">
                    <i class="fas fa-calendar-alt me-2"></i>
                    @ViewBag.StartDate.ToString("dd MMMM yyyy") - @ViewBag.EndDate.ToString("dd MMMM yyyy")
                </p>
            }
            else
            {
                <p class="mb-0 mt-2">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Rapor Tarihi: @DateTime.Now.ToString("dd MMMM yyyy")
                </p>
            }
        </div>
    </div>

    <!-- Financial Overview -->
    @if (ViewBag.Summary != null && ViewBag.Summary is not JsonElement)
    {
        <div class="report-section">
            <h3 class="mb-4">
                <i class="fas fa-chart-bar me-2"></i>
                Finansal Özet
            </h3>
            
            <div class="financial-grid">
                <div class="financial-card card-revenue">
                    <div class="financial-value text-success">₺@ViewBag.Summary.TotalSaleAmount.ToString("N0")</div>
                    <div class="financial-label">Toplam Gelir</div>
                    <div class="financial-change text-success">
                        <i class="fas fa-arrow-up me-1"></i>Ana gelir kaynağı
                    </div>
                </div>
                
                <div class="financial-card card-cost">
                    <div class="financial-value text-warning">₺@ViewBag.Summary.TotalPurchaseAmount.ToString("N0")</div>
                    <div class="financial-label">Toplam Maliyet</div>
                    <div class="financial-change text-warning">
                        <i class="fas fa-minus me-1"></i>Operasyonel giderler
                    </div>
                </div>
                
                <div class="financial-card card-profit">
                    <div class="financial-value text-danger">₺@ViewBag.Summary.TotalProfit.ToString("N0")</div>
                    <div class="financial-label">Net Kâr</div>
                    <div class="financial-change @(ViewBag.Summary.TotalProfit >= 0 ? "text-success" : "text-danger")">
                        <i class="fas fa-@(ViewBag.Summary.TotalProfit >= 0 ? "arrow-up" : "arrow-down") me-1"></i>
                        @(ViewBag.Summary.TotalProfit >= 0 ? "Pozitif" : "Negatif") sonuç
                    </div>
                </div>
                
                <div class="financial-card card-margin">
                    <div class="financial-value text-info">
                        %@(ViewBag.Summary.TotalSaleAmount > 0 ? ((ViewBag.Summary.TotalProfit / ViewBag.Summary.TotalSaleAmount) * 100).ToString("N1") : "0.0")
                    </div>
                    <div class="financial-label">Kâr Marjı</div>
                    <div class="financial-change text-info">
                        <i class="fas fa-percentage me-1"></i>Kârlılık oranı
                    </div>
                </div>
            </div>
        </div>

        <!-- Profit Breakdown -->
        <div class="report-section">
            <h3 class="mb-4">
                <i class="fas fa-calculator me-2"></i>
                Kâr-Zarar Analizi
            </h3>
            
            <div class="profit-breakdown">
                <div class="breakdown-item">
                    <div class="breakdown-label">
                        <i class="fas fa-plus-circle text-success me-2"></i>
                        Toplam Satış Geliri
                    </div>
                    <div class="breakdown-value text-success">₺@ViewBag.Summary.TotalSaleAmount.ToString("N2")</div>
                </div>
                
                <div class="breakdown-item">
                    <div class="breakdown-label">
                        <i class="fas fa-minus-circle text-warning me-2"></i>
                        Toplam Maliyet
                    </div>
                    <div class="breakdown-value text-warning">₺@ViewBag.Summary.TotalPurchaseAmount.ToString("N2")</div>
                </div>
                
                <div class="breakdown-item">
                    <div class="breakdown-label">
                        <i class="fas fa-equals text-primary me-2"></i>
                        <strong>NET KÂR</strong>
                    </div>
                    <div class="breakdown-value @(ViewBag.Summary.TotalProfit >= 0 ? "text-success" : "text-danger")">
                        ₺@ViewBag.Summary.TotalProfit.ToString("N2")
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Indicators -->
        <div class="report-section">
            <h3 class="mb-4">
                <i class="fas fa-tachometer-alt me-2"></i>
                Performans Göstergeleri
            </h3>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="monthly-summary">
                        <h5 class="mb-3">
                            <i class="fas fa-chart-line me-2"></i>
                            Finansal Metrikler
                        </h5>
                        
                        <div class="month-item">
                            <div class="month-name">Ortalama Satış Tutarı</div>
                            <div class="month-values">
                                <span class="text-primary">
                                    ₺@(ViewBag.Summary.TotalSales > 0 ? (ViewBag.Summary.TotalSaleAmount / ViewBag.Summary.TotalSales).ToString("N0") : "0")
                                </span>
                            </div>
                        </div>
                        
                        <div class="month-item">
                            <div class="month-name">Ortalama Maliyet</div>
                            <div class="month-values">
                                <span class="text-warning">
                                    ₺@(ViewBag.Summary.TotalSales > 0 ? (ViewBag.Summary.TotalPurchaseAmount / ViewBag.Summary.TotalSales).ToString("N0") : "0")
                                </span>
                            </div>
                        </div>
                        
                        <div class="month-item">
                            <div class="month-name">Ortalama Kâr</div>
                            <div class="month-values">
                                <span class="text-success">
                                    ₺@(ViewBag.Summary.TotalSales > 0 ? (ViewBag.Summary.TotalProfit / ViewBag.Summary.TotalSales).ToString("N0") : "0")
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="monthly-summary">
                        <h5 class="mb-3">
                            <i class="fas fa-percentage me-2"></i>
                            Oran Analizi
                        </h5>
                        
                        <div class="month-item">
                            <div class="month-name">Maliyet Oranı</div>
                            <div class="month-values">
                                <span class="text-warning">
                                    %@(ViewBag.Summary.TotalSaleAmount > 0 ? ((ViewBag.Summary.TotalPurchaseAmount / ViewBag.Summary.TotalSaleAmount) * 100).ToString("N1") : "0.0")
                                </span>
                            </div>
                        </div>
                        
                        <div class="month-item">
                            <div class="month-name">Kâr Oranı</div>
                            <div class="month-values">
                                <span class="text-success">
                                    %@(ViewBag.Summary.TotalSaleAmount > 0 ? ((ViewBag.Summary.TotalProfit / ViewBag.Summary.TotalSaleAmount) * 100).ToString("N1") : "0.0")
                                </span>
                            </div>
                        </div>
                        
                        <div class="month-item">
                            <div class="month-name">Verimlilik</div>
                            <div class="month-values">
                                <span class="@(ViewBag.Summary.TotalProfit >= 0 ? "text-success" : "text-danger")">
                                    @(ViewBag.Summary.TotalProfit >= 0 ? "OLUMLU" : "OLUMSUZ")
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Report Footer -->
    <div class="report-footer">
        <p>
            <i class="fas fa-calendar me-2"></i>
            Rapor Oluşturma Tarihi: @DateTime.Now.ToString("dd MMMM yyyy HH:mm")
        </p>
        <p class="mb-0">
            <i class="fas fa-building me-2"></i>
            SD Turizm - Finansal Rapor Sistemi
        </p>
    </div>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-filter me-2"></i>Finansal Rapor Filtreleri
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="get">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-calendar me-1"></i>Başlangıç Tarihi
                                </label>
                                <input type="date" class="form-control" name="startDate" value="@ViewBag.StartDate?.ToString("yyyy-MM-dd")" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-calendar me-1"></i>Bitiş Tarihi
                                </label>
                                <input type="date" class="form-control" name="endDate" value="@ViewBag.EndDate?.ToString("yyyy-MM-dd")" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>İptal
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-1"></i>Filtrele
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>